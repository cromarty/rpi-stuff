
    
new_image() {
	    local WORKDIR=${1}
	    	  local IMAGEFILE=${2}
	local ROOTMP=${3}
	local BLOCKCOUNT=${4}
local BLOCKSIZE=${5}
local SPLIT=${6}	    

	echo "Making the work directory if it doesn't exist..."
	[ -d ${WORKDIR} ] || mkdir -p "${WORKDIR}"

	echo "Running dd to make a raw (zero-filled) image"
	dd if=/dev/zero of=${IMAGEFILE} bs=${BLOCKSIZE} count=${BLOCKCOUNT}

	echo "Partitioning the raw image file..."
	parted "${IMAGEFILE}" --script -- mklabel msdos
	echo 'Making the boot partition...'
	parted "${IMAGEFILE}" --script -- mkpart primary fat32 1 ${SPLIT}
	echo 'Setting the boot partition bootable...'
	parted "${IMAGEFILE}" --script set 1 boot on
	echo 'Making the root partition...'
	parted "${IMAGEFILE}" --script -- mkpart primary ext4 ${SPLIT} -1
local BOOTP
local ROOTP

	loop_devices ${WORKDIR} ${IMAGEFILE} BOOTP ROOTP

	#echo "Writing loop device names to ${WORKDIR}/imgtool-loop-dev-names"
		#LD1PATH=$(realpath ${BOOTP})
	#LD2PATH=$(realpath ${ROOTP})
		#echo -e "${LD1PATH}\n${LD2PATH}" > "${WORKDIR}/imgtool-loop-dev-names"

	echo "Boot partition is ${BOOTP}"
	echo "Root partition is ${ROOTP}"

	sleep 5

	echo "Making file systems..."
	mkfs.vfat ${BOOTP}
	mkfs.ext4 ${ROOTP}

	mount_partitions ${WORKDIR} ${BOOTP} ${ROOTP} ${ROOTMP}

}
