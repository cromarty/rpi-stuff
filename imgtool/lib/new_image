

new_image() {
	local WORKDIR=${1}
	local IMAGEFILE=${2}
	local ROOTMP=${3}
	local BLOCKCOUNT=${4}
	local BLOCKSIZE=${5}
	local SPLIT=${6}	    

	echo $(gettext "Making the work directory if it doesn't exist") ; echo
	[ -d ${WORKDIR} ] || mkdir -p "${WORKDIR}"

	echo $(gettext "Running dd to make a raw (zero-filled) image") ; echo
	dd if=/dev/zero of=${IMAGEFILE} bs=${BLOCKSIZE} count=${BLOCKCOUNT}

	echo $(gettext "Partitioning the raw image file") ; echo
	parted "${IMAGEFILE}" --script -- mklabel msdos
	echo $(gettext "Making the boot partition") ; echo
	parted "${IMAGEFILE}" --script -- mkpart primary fat32 1 ${SPLIT}
	echo $(gettext "Setting the boot partition bootable") ; echo
	parted "${IMAGEFILE}" --script set 1 boot on
	echo $(gettext "Making the root partition") ; echo
	parted "${IMAGEFILE}" --script -- mkpart primary ext4 ${SPLIT} -1
	local BOOTP
	local ROOTP

	loop_devices ${WORKDIR} ${IMAGEFILE} BOOTP ROOTP

	echo $(eval_gettext "Boot partition is \$BOOTP") ; echo
	echo $(eval_gettext "Root partition is \$ROOTP}") ; echo

	sleep 5

	echo $(gettext "Making file systems") ; echo
	mkfs.vfat ${BOOTP}
	mkfs.ext4 ${ROOTP}

	mount_partitions ${WORKDIR} ${BOOTP} ${ROOTP} ${ROOTMP}

}
