
loop_devices() {
local WORKDIR=${1}
local IMAGEFILE=${2}

local __BOOTP=${3}
local __ROOTP=${4}

	echo "Setting up the loop device..."

	LOOPDEVICE=$(losetup -f --show ${IMAGEFILE})
	DEVICE=$(kpartx -va ${LOOPDEVICE} | sed -E 's/.*(loop[0-9][0-9]*)p.*/\1/g' | head -1)
	DEVICE="/dev/mapper/${DEVICE}"
BOOTP=${DEVICE}p1
ROOTP=${DEVICE}p2

	eval $__BOOTP="'$BOOTP'"
	eval $__ROOTP="'$ROOTP'"
}

